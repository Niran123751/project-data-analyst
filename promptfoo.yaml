description: "TDS Data Analyst Agent â€“ local test"
providers:
  - id: https
    config:
      url: http://127.0.0.1:8000/api/  # Change to your deployed API URL
      method: POST
      body:
        file: questions.txt
      transformResponse: json

assert:
  - type: is-json
    value: { type: array, minItems: 4, maxItems: 4 }
    weight: 0

  - type: python
    weight: 4
    value: |
      import json, sys
      print(json.loads(output)[0] == 1)

  - type: python
    weight: 4
    value: |
      import json, re
      print(bool(re.search(r'titanic', json.loads(output)[1], re.I)))

  - type: python
    weight: 4
    value: |
      import json
      print(abs(float(json.loads(output)[2]) - 0.485782) <= 0.001)

  - type: llm-rubric
    provider: openai:gpt-4.1-nano
    weight: 8
    preprocess: |
      import json
      data = json.loads(output)
      context['plot'] = data[3]
    rubricPrompt: |
      [
        { "role": "system",
          "content": "Grade the scatterplot. Award score 1 only if: \
          (a) scatterplot of Rank vs Peak; \
          (b) dotted red regression line; \
          (c) axes visible & labelled; \
          (d) size < 100 kB. Respond JSON: {scatterplot:bool, regression:bool, axes:bool, size:bool, score:number}"
        },
        { "role": "user",
          "content": [
            { "type": "image_url",
              "image_url": { "url": "{{plot}}" }
            }
          ]
        }
      ]
    threshold: 0.99

tests:
  - description: "Wikipedia Highest Grossing Films Test"
